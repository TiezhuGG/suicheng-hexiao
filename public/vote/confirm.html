<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<script src="js/rem.js"></script>
		<script src="https://cn.vuejs.org/js/vue.min.js"></script>
		<script src="https://cdn.staticfile.org/axios/0.18.0/axios.min.js"></script>
		<script src="js/common.js"></script>
		<title>核销签到</title>
		<link rel="stylesheet" href="css/common.css">
	</head>
	<body>
		<div id="confirm">
			<!-- 核销 -->
			<div class="confirm" v-if="code==200">
				<img src="imgs/i20.png" />
				<div class="tip">核销签到成功</div>
				<!-- <div class="but">确定</div> -->
			</div>
		</div>
		<script>
			var app = new Vue({
				el: '#confirm',
				data: {
					url: 'http://hx.le-cx.com/',
					code:0,
					config: {
						res:'',
						code:'',
						uid:'',
						openid:'',
						name:'',
						pid:'',
						appid: 'wxd6f30cb38ce4a273'
					} 
				},
				created: function () {
					var _ = this;
					_.userinfo(); 
					// _.test();
				},
				methods: {
					test(){
						var _ = this;
						_.config.uid = 7;
						_.config.openid = 'ovvUKwoerIWLGoSupJhv5QGO32gs';
						_.config.name = '也许';
						_.config.pid = _.GetQueryString('paper_id');
						
						axios.get(_.url+'api/sign/hexiao', {
							params: {
								signlist_id: _.config.pid,
								openid: _.config.openid
							}
						}).then(function (res) {
							alert(res.data.Msg);
						});
					},
					userinfo(){
						var _ = this;
						var url = encodeURI(window.location.href);
						var code = _.GetQueryString('code');
						// var code = '021eDoYm1ZWJXq00mhZm1HeyYm1eDoY0';
						if (code==''||code==null){
							window.location.href='https://open.weixin.qq.com/connect/oauth2/authorize?appid='+_.config.appid+'&redirect_uri='+url+'&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect';
						}else{
							_.config.code = code;
			
								// _.config.res = code;
							axios.get(_.url+'api/Getwxuser/get_user_all', {
								params: {
									code: code
								}
							}).then(function (res) {
								if(res.data.code==200){
									_.config.uid = res.data.userid;
									_.config.openid = res.data.openid;
									_.config.name = res.data.name;
									_.config.pid = _.GetQueryString('paper_id');
									
									axios.get(_.url+'api/sign/hexiao', {
										params: {
											signlist_id: _.config.pid,
											openid: _.config.openid
										}
									}).then(function (res) {
										// alert(JSON.stringify(res));
										_.code = res.data.code;
										if(_.code!=200){
											alert(res.data.msg);
										}
									});
								}else{
									window.location.href='https://open.weixin.qq.com/connect/oauth2/authorize?appid='+_.config.appid+'&redirect_uri='+url+'&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect';
								}
							});
						}
					},
					GetQueryString(name){
					    var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
					    var r = window.location.search.substr(1).match(reg);//search,查询？后面的参数，并匹配正则
					    if(r!=null)return r[2]; return null;
					}
				}
			})
		</script>
	</body>
</html>
